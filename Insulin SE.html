<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Advanced Insulin Dosage Calculator</title>
    <style>
        /* 6. Modernized UI/UX with CSS Variables */
        :root {
            --primary-color: #005A9C;
            --primary-hover: #004B80;
            --background-color: #f8f9fa;
            --container-bg: #ffffff;
            --text-color: #333;
            --border-color: #dee2e6;
            --shadow-color: rgba(0, 0, 0, 0.08);
            --font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
        }

        body {
            font-family: var(--font-family);
            background: var(--background-color);
            margin: 0;
            padding: 20px;
            color: var(--text-color);
            line-height: 1.6;
        }

        /* 7. Improved HTML Semantics (Styling for <main>, <header>, etc.) */
        .container {
            max-width: 750px;
            margin: 0 auto;
            background: var(--container-bg);
            padding: 30px 40px;
            border-radius: 12px;
            box-shadow: 0 4px 20px var(--shadow-color);
        }

        header h1 {
            text-align: center;
            color: var(--primary-color);
            margin-bottom: 25px;
            font-size: 2em;
        }
        
        h2 {
            border-bottom: 2px solid var(--border-color);
            padding-bottom: 8px;
            margin-top: 30px;
            color: #343a40;
        }

        ul {
            list-style-type: none;
            padding-left: 0;
        }

        ul li {
            background: #e9ecef;
            padding: 8px 12px;
            border-radius: 6px;
            margin-bottom: 8px;
        }

        /* 1. Prominent Medical Disclaimer */
        .disclaimer {
            background: #fff3cd;
            color: #856404;
            padding: 15px;
            border: 1px solid #ffeeba;
            border-radius: 8px;
            text-align: center;
            margin-bottom: 25px;
            font-weight: bold;
        }

        /* 5. Enhanced Form Accessibility & UX Styling */
        form fieldset {
            border: none;
            padding: 0;
            margin: 0;
        }
        
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
        }
        input {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            box-sizing: border-box; /* Ensures padding doesn't affect width */
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        
        input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(0, 90, 156, 0.2);
        }

        button {
            padding: 12px 20px;
            background: var(--primary-color);
            color: #fff;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            display: block;
            width: 100%;
            margin-top: 25px;
            font-size: 1.1em;
            font-weight: bold;
            transition: background-color 0.2s;
        }

        button:hover {
            background: var(--primary-hover);
        }
        
        /* 12. Button Disabled State */
        button:disabled {
            background-color: #6c757d;
            cursor: not-allowed;
        }

        /* Styling for validation errors */
        .error-message {
            color: #721c24;
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            padding: 10px;
            border-radius: 6px;
            margin-top: 20px;
            display: none; /* Hidden by default */
        }
        
        .result-container {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-top: 30px;
            border: 1px solid var(--border-color);
            /* Animation for results appearing */
            opacity: 0;
            transform: translateY(10px);
            transition: opacity 0.4s ease-out, transform 0.4s ease-out;
        }
        
        .result-container.visible {
            opacity: 1;
            transform: translateY(0);
        }

        .advice {
            margin-top: 15px;
            padding: 15px;
            border-radius: 5px;
            font-weight: 500;
        }

        .ok { background: #d4edda; color: #155724; }
        .low { background: #e7f3ff; color: #004085; }
        .medium { background: #fff3cd; color: #856404; }
        .danger { background: #f8d7da; color: #721c24; }
        
        footer {
            text-align: center;
            margin-top: 30px;
            font-size: 0.9em;
            color: #6c757d;
        }

    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Advanced Insulin Dosage Calculator</h1>
            <div class="disclaimer">
                <strong>Disclaimer:</strong> This tool is for informational purposes only and is not a substitute for professional medical advice. Always consult a healthcare provider.
            </div>
        </header>

        <main>
            <section class="info">
                <h2>Target Blood Sugar Levels</h2>
                <ul>
                    <li><strong>Before meals:</strong> 80â€“130 mg/dL</li>
                    <li><strong>After meals (1-2 hours):</strong> Below 180 mg/dL</li>
                </ul>
            </section>

            <section class="calculator">
                <h2>Dosage Calculator</h2>
                <form id="insulinForm">
                    <fieldset>
                        <div class="form-grid">
                            <div>
                                <label for="weight">Weight (kg):</label>
                                <input type="number" id="weight" placeholder="e.g., 70" required min="0">
                            </div>
                            <div>
                                <label for="carbs">Carbohydrate Intake (g):</label>
                                <input type="number" id="carbs" placeholder="e.g., 60" required min="0">
                            </div>
                            <div>
                                <label for="glucose">Current Blood Glucose (mg/dL):</label>
                                <input type="number" id="glucose" placeholder="e.g., 160" required min="0">
                            </div>
                            <div>
                                <label for="target">Target Blood Glucose (mg/dL):</label>
                                <input type="number" id="target" value="120" required min="0">
                            </div>
                            <div>
                                <label for="icr">Insulin-to-Carb Ratio (ICR):</label>
                                <input type="number" id="icr" value="15" placeholder="1 unit per X grams" required min="0">
                            </div>
                            <div>
                                <label for="cf">Correction Factor (CF):</label>
                                <input type="number" id="cf" value="50" placeholder="1 unit lowers by X mg/dL" required min="0">
                            </div>
                        </div>
                        <button type="submit" id="calculateBtn">Calculate Dosage</button>
                    </fieldset>
                </form>

                <div id="errorMessage" class="error-message"></div>
                
                <div id="result" class="result-container"></div>
            </section>
        </main>
        
        <footer>
            <p>Maintain a healthy lifestyle and monitor your glucose regularly.</p>
        </footer>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const form = document.getElementById('insulinForm');
            const resultDiv = document.getElementById('result');
            const errorDiv = document.getElementById('errorMessage');
            const calculateBtn = document.getElementById('calculateBtn');

            // 9. Use Constants for "Magic Numbers"
            const TOTAL_DAILY_DOSE_FACTOR = 0.55; // A common factor for TDD calculation
            const BASAL_BOLUS_SPLIT_RATIO = 0.5; // 50% basal, 50% bolus

            form.addEventListener('submit', function(e) {
                e.preventDefault();
                // 12. Prevent Double Submission
                calculateBtn.disabled = true;
                
                // Clear previous results and errors
                errorDiv.style.display = 'none';
                resultDiv.classList.remove('visible');
                
                const inputs = {
                    weight: parseFloat(document.getElementById('weight').value),
                    carbs: parseFloat(document.getElementById('carbs').value),
                    glucose: parseFloat(document.getElementById('glucose').value),
                    target: parseFloat(document.getElementById('target').value),
                    icr: parseFloat(document.getElementById('icr').value),
                    cf: parseFloat(document.getElementById('cf').value)
                };

                // 3. Robust Input Validation
                if (!validateInputs(inputs)) {
                    calculateBtn.disabled = false;
                    return;
                }

                // 8. Decouple Calculations from Display
                const results = calculateDosage(inputs);
                displayResults(results);
                
                calculateBtn.disabled = false;
            });
            
            // 3. Centralized validation function
            function validateInputs(inputs) {
                let messages = [];
                if (isNaN(inputs.weight) || inputs.weight <= 0) messages.push("Weight must be a positive number.");
                if (isNaN(inputs.carbs) || inputs.carbs < 0) messages.push("Carbohydrates cannot be negative.");
                if (isNaN(inputs.glucose) || inputs.glucose <= 0) messages.push("Current Blood Glucose must be a positive number.");
                if (isNaN(inputs.target) || inputs.target <= 0) messages.push("Target Blood Glucose must be a positive number.");
                if (isNaN(inputs.icr) || inputs.icr <= 0) messages.push("ICR must be a positive number.");
                if (isNaN(inputs.cf) || inputs.cf <= 0) messages.push("Correction Factor must be a positive number.");

                if (messages.length > 0) {
                    errorDiv.textContent = messages.join(' ');
                    errorDiv.style.display = 'block';
                    return false;
                }
                return true;
            }
            
            // 3. Function dedicated to calculation
            function calculateDosage({ weight, carbs, glucose, target, icr, cf }) {
                // 11. Add Clear Code Comments
                // Total Daily Dose (TDD) is an estimate of total insulin needs for a day.
                const totalDailyDose = weight * TOTAL_DAILY_DOSE_FACTOR;
                const basalDose = totalDailyDose * BASAL_BOLUS_SPLIT_RATIO;
                
                // Meal insulin covers the carbohydrates consumed.
                const mealInsulin = carbs / icr;
                
                // Correction insulin adjusts for current high blood sugar.
                let correctionInsulin = 0;
                if (glucose > target) {
                    correctionInsulin = (glucose - target) / cf;
                }
                
                // Total bolus is the sum for the meal and correction, cannot be negative.
                const totalBolus = mealInsulin + correctionInsulin;

                const advice = getAdvice(glucose);

                return {
                    totalDailyDose,
                    basalDose,
                    mealInsulin,
                    correctionInsulin, // 10. Clarified logic for negative correction
                    totalBolus,
                    advice
                };
            }
            
            // 2 & 3. Corrected and separated medical advice logic
            function getAdvice(glucose) {
                if (glucose < 70) {
                    return {
                        message: "Your blood sugar is low (Hypoglycemia). Treat immediately.",
                        prescription: "Follow the 'Rule of 15': Consume 15g of fast-acting carbs (glucose tabs, juice), wait 15 mins, and re-check. If severe, a Glucagon injection may be needed.",
                        className: 'low'
                    };
                } else if (glucose >= 70 && glucose <= 180) {
                    return {
                        message: "Your blood sugar is in a good range. Continue your routine.",
                        prescription: "Maintain your prescribed basal insulin and healthy diet.",
                        className: 'ok'
                    };
                } else if (glucose > 180 && glucose <= 250) {
                    return {
                        message: "Your blood sugar is high. The calculated correction dose should help.",
                        prescription: "Administer the calculated bolus dose of rapid-acting insulin (e.g., Lispro, Aspart). Monitor your levels and ensure you are hydrated.",
                        className: 'medium'
                    };
                } else { // glucose > 250
                    return {
                        message: "Your blood sugar is very high. This requires immediate attention.",
                        prescription: "Administer correction dose of **rapid-acting insulin**. **Do NOT use long-acting insulin for correction.** Check for ketones. If levels remain very high or you feel unwell, contact your doctor or seek emergency care immediately.",
                        className: 'danger'
                    };
                }
            }
            
            // 3. Function dedicated to rendering results to the DOM
            function displayResults({ totalDailyDose, basalDose, mealInsulin, correctionInsulin, totalBolus, advice }) {
                // 13. Efficient single innerHTML update
                resultDiv.innerHTML = `
                    <h3>Calculation Results</h3>
                    <p><strong>Estimated Total Daily Insulin:</strong> ${totalDailyDose.toFixed(2)} units</p>
                    <p><strong>Estimated Daily Basal Dose:</strong> ${basalDose.toFixed(2)} units</p>
                    <hr style="border-top: 1px solid var(--border-color); border-bottom: none; margin: 15px 0;">
                    <p><strong>Meal Bolus (for carbs):</strong> ${mealInsulin.toFixed(2)} units</p>
                    <p><strong>Correction Bolus (to lower high BG):</strong> ${correctionInsulin.toFixed(2)} units</p>
                    <p><strong><strong>Total Bolus for this meal:</strong> ${totalBolus.toFixed(2)} units</strong></p>

                    <div class="advice ${advice.className}">
                        <p><strong>Advice:</strong> ${advice.message}</p>
                        <p><strong>Suggested Action:</strong> ${advice.prescription}</p>
                    </div>
                `;
                
                // Add class to trigger the animation
                setTimeout(() => {
                    resultDiv.classList.add('visible');
                }, 10);
            }
        });
    </script>
</body>

</html>
